{% extends "layout.html" %}

{% block title %}积分商城{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shop.css') }}">
{% endblock %}

{% set colors = ['#fde2e2', '#e2f0cb', '#d0e8f2', '#fff1e6', '#fcefe3', '#e0e0f8', '#e3fcef'] %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>🎁 积分商城</h2>
        <a class="btn btn-outline-primary" href="/">← 返回首页</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <p class="mb-4">你好，<strong>{{ username }}</strong>！你当前有 <span class="text-success fw-bold">{{ points }}</span> 积分</p>

    {% if username == 'admin' %}
      <a href="{{ url_for('add_coupon') }}" class="btn btn-success mb-4">➕ 添加新券</a>
    {% endif %}

    <div class="row">
        {% for item in coupon_store %}
        <div class="col-md-6 col-lg-4">
            {% set bg_color = colors[loop.index0 % colors|length] %}
            <div class="coupon-card" style="background-color: {{ bg_color }};">
                <div class="coupon-title">🎫 {{ item.type }}</div>
                <div class="text-muted mb-2">{{ item.desc }}</div>
                <div class="coupon-cost mb-3">所需积分：{{ item.cost }}</div>

                {% if username == 'admin' %}
                    <div class="admin-actions">
                        <a href="{{ url_for('edit_coupon', coupon_id=item.id) }}" class="btn btn-sm btn-warning">编辑</a>
                        <form action="{{ url_for('delete_coupon', coupon_id=item.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('确认删除该券？');">
                            <button class="btn btn-sm btn-danger">删除</button>
                        </form>
                    </div>
                {% else %}
                    <form method="POST" action="{{ url_for('redeem_coupon') }}">
                        <input type="hidden" name="coupon_type" value="{{ item.type }}">
                        <button type="submit" class="btn btn-primary w-100">兑换</button>
                    </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
